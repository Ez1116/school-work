<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿåˆ†çµ„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .seat {
            transition: all 0.2s ease;
            user-select: none;
        }

        .seat:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .seat.active {
            background-color: #22c55e;
        }

        .seat.inactive {
            background-color: #ef4444;
        }

        .seat.leader {
            position: relative;
        }

        .seat.leader::after {
            content: 'ãŠ—ï¸';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 14px;
        }

        .leader-mode-active {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }

        .group-card {
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .group-label {
            background-color: #3b82f6;
            color: white;
            padding: 10px 16px;
            font-weight: 700;
            text-align: center;
            font-size: 15px;
        }

        .group-members {
            display: flex;
            flex-wrap: wrap;
            padding: 12px;
            gap: 8px;
            background-color: #f8fafc;
            flex: 1;
            align-items: flex-start;
            align-content: flex-start;
        }

        .member {
            padding: 6px 12px;
            background-color: white;
            border-radius: 20px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
        }

        .member.is-leader {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* å¯¦é©—å®¤åº§ä½åœ–æ¨£å¼ */
        .lab-layout {
            display: flex;
            flex-direction: column;
            gap: 32px;
            align-items: center;
        }

        .teacher-desk {
            background-color: #a5b4fc;
            padding: 12px 60px;
            border-radius: 4px;
            font-weight: bold;
            color: #1e3a8a;
        }

        .lab-row {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .lab-bench {
            display: flex;
            align-items: stretch;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .lab-bench.empty {
            opacity: 0.4;
            background-color: #f1f5f9;
        }

        .bench-seats-left, .bench-seats-right {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bench-label {
            background-color: #3b82f6;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 24px;
            border-radius: 4px;
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        .lab-bench.empty .bench-label {
            background-color: #94a3b8;
        }

        .bench-seat {
            padding: 6px 10px;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
            font-size: 14px;
        }

        .bench-seat.is-leader {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }

        .bench-seat.empty-seat {
            visibility: hidden;
        }

        .extra-groups-notice {
            margin-top: 16px;
            padding: 12px 20px;
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            color: #92400e;
            font-weight: 500;
        }

        .extra-groups-container {
            margin-top: 24px;
        }

        .extra-groups-container h3 {
            font-weight: bold;
            margin-bottom: 12px;
            color: #374151;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto">
        <!-- æ¨™é¡Œ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                ğŸ“š å­¸ç”Ÿåˆ†çµ„ç³»çµ±
            </h1>
        </div>

        <!-- è¨­å®šå€ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <div class="flex items-center gap-2">
                    <label class="font-medium text-gray-700">çµ„æ•¸:</label>
                    <input type="number" id="groupCount" min="1" max="50" value="8"
                           class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center gap-2">
                    <label class="font-medium text-gray-700">æ¯çµ„äººæ•¸:</label>
                    <input type="text" id="groupSize" placeholder="å¦‚: 4 æˆ– 3-5"
                           class="w-28 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="leaderModeBtn" onclick="toggleLeaderMode()"
                        class="px-4 py-2 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600 transition-colors">
                    é¸çµ„é•·æ¨¡å¼
                </button>
                <button onclick="randomizeGroups()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                    é–‹å§‹åˆ†çµ„
                </button>
                <button onclick="resetAll()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors">
                    é‡ç½®
                </button>
            </div>
        </div>

        <!-- åº§ä½è¡¨ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">åº§ä½è¡¨</h2>
            <div id="seatChart" class="grid grid-cols-10 gap-2 mb-4">
                <!-- åº§ä½æœƒç”± JavaScript ç”Ÿæˆ -->
            </div>

            <!-- åœ–ä¾‹ -->
            <div class="flex flex-wrap gap-6 pt-4 border-t border-gray-200">
                <div class="legend-item">
                    <div class="legend-box bg-green-500"></div>
                    <span>åƒèˆ‡åˆ†çµ„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box bg-red-500"></div>
                    <span>ä¸åƒèˆ‡</span>
                </div>
                <div class="legend-item">
                    <span>ãŠ—ï¸</span>
                    <span>çµ„é•·</span>
                </div>
            </div>

            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div id="statsInfo" class="mt-4 text-sm text-gray-600">
                <!-- çµ±è¨ˆè³‡è¨Šæœƒç”± JavaScript æ›´æ–° -->
            </div>
        </div>

        <!-- åˆ†çµ„çµæœ -->
        <div id="resultsSection" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">åˆ†çµ„çµæœ</h2>
                <button onclick="downloadResultsImage()"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium">
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
            </div>
            <div id="resultsContainer" class="results-container">
                <!-- çµæœæœƒç”± JavaScript ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // ç‹€æ…‹ç®¡ç†
        const state = {
            students: [],
            settings: {
                groupCount: 8,
                groupSize: null,
                leaderMode: false
            },
            groups: []
        };

        // åˆå§‹åŒ–å­¸ç”Ÿè³‡æ–™
        function initStudents() {
            state.students = [];
            for (let i = 1; i <= 50; i++) {
                state.students.push({
                    id: i,
                    active: true,
                    isLeader: false
                });
            }
        }

        // åˆ‡æ›å­¸ç”Ÿåƒèˆ‡ç‹€æ…‹
        function toggleStudent(id) {
            const student = state.students.find(s => s.id === id);
            if (!student) return;

            if (state.settings.leaderMode) {
                // çµ„é•·æ¨¡å¼ï¼šåªæœ‰åƒèˆ‡çš„å­¸ç”Ÿå¯ä»¥è¨­ç‚ºçµ„é•·
                if (student.active) {
                    student.isLeader = !student.isLeader;
                }
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šåˆ‡æ›åƒèˆ‡ç‹€æ…‹
                student.active = !student.active;
                // å¦‚æœè¨­ç‚ºä¸åƒèˆ‡ï¼Œå–æ¶ˆçµ„é•·èº«ä»½
                if (!student.active) {
                    student.isLeader = false;
                }
            }

            renderSeatChart();
            updateStats();
        }

        // åˆ‡æ›çµ„é•·é¸æ“‡æ¨¡å¼
        function toggleLeaderMode() {
            state.settings.leaderMode = !state.settings.leaderMode;
            const btn = document.getElementById('leaderModeBtn');

            if (state.settings.leaderMode) {
                btn.classList.add('leader-mode-active', 'ring-2', 'ring-amber-300');
                btn.textContent = 'é€€å‡ºçµ„é•·æ¨¡å¼';
            } else {
                btn.classList.remove('leader-mode-active', 'ring-2', 'ring-amber-300');
                btn.textContent = 'é¸çµ„é•·æ¨¡å¼';
            }

            renderSeatChart();
        }

        // è§£æäººæ•¸è¼¸å…¥
        function parseGroupSize(input) {
            if (!input || input.trim() === '') return null;

            const trimmed = input.trim();

            // æª¢æŸ¥æ˜¯å¦ç‚ºå€é–“æ ¼å¼ (å¦‚ 3-5)
            if (trimmed.includes('-')) {
                const parts = trimmed.split('-');
                if (parts.length === 2) {
                    const min = parseInt(parts[0]);
                    const max = parseInt(parts[1]);
                    if (!isNaN(min) && !isNaN(max) && min <= max) {
                        return { min, max };
                    }
                }
            }

            // å–®ä¸€æ•¸å­—
            const num = parseInt(trimmed);
            if (!isNaN(num) && num > 0) {
                return num;
            }

            return null;
        }

        // Fisher-Yates æ´—ç‰Œæ¼”ç®—æ³•
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // åŸ·è¡Œåˆ†çµ„
        function randomizeGroups() {
            // å–å¾—è¨­å®š
            const groupCountInput = document.getElementById('groupCount').value;
            const groupSizeInput = document.getElementById('groupSize').value;

            const groupCount = parseInt(groupCountInput) || 8;
            const groupSize = parseGroupSize(groupSizeInput);

            // æ”¶é›†åƒèˆ‡çš„å­¸ç”Ÿ
            const activeStudents = state.students.filter(s => s.active);
            const leaders = activeStudents.filter(s => s.isLeader);
            const nonLeaders = activeStudents.filter(s => !s.isLeader);

            if (activeStudents.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½å­¸ç”Ÿåƒèˆ‡åˆ†çµ„ï¼');
                return;
            }

            if (groupCount > activeStudents.length) {
                alert('çµ„æ•¸ä¸èƒ½å¤§æ–¼åƒèˆ‡äººæ•¸ï¼');
                return;
            }

            // åˆå§‹åŒ–åˆ†çµ„
            state.groups = [];
            for (let i = 0; i < groupCount; i++) {
                state.groups.push({
                    id: i + 1,
                    members: [],
                    leaderId: null
                });
            }

            // æ‰“äº‚çµ„åˆ¥é †åºç´¢å¼•ï¼Œç”¨æ–¼éš¨æ©Ÿåˆ†é…çµ„é•·
            const shuffledGroupIndices = shuffle([...Array(groupCount).keys()]);

            // åˆ†é…çµ„é•·åˆ°éš¨æ©Ÿçµ„åˆ¥
            const shuffledLeaders = shuffle(leaders);
            for (let i = 0; i < Math.min(shuffledLeaders.length, groupCount); i++) {
                const targetGroupIdx = shuffledGroupIndices[i];
                state.groups[targetGroupIdx].members.push(shuffledLeaders[i]);
                state.groups[targetGroupIdx].leaderId = shuffledLeaders[i].id;
            }

            // æ´—ç‰Œéçµ„é•·å­¸ç”Ÿ
            const shuffledNonLeaders = shuffle(nonLeaders);

            // å¦‚æœçµ„é•·æ•¸é‡å°‘æ–¼çµ„æ•¸ï¼Œéœ€è¦å¾éçµ„é•·ä¸­é¸å‡ºçµ„é•·
            const groupsNeedingLeaders = state.groups.filter(g => g.leaderId === null);
            // æ‰“äº‚éœ€è¦çµ„é•·çš„çµ„åˆ¥é †åº
            const shuffledGroupsNeedingLeaders = shuffle(groupsNeedingLeaders);
            for (const group of shuffledGroupsNeedingLeaders) {
                if (shuffledNonLeaders.length > 0) {
                    const newLeader = shuffledNonLeaders.shift();
                    group.members.push(newLeader);
                    group.leaderId = newLeader.id;
                }
            }

            // éš¨æ©Ÿåˆ†é…å‰©é¤˜å­¸ç”Ÿï¼ˆä¸ä½¿ç”¨ round-robinï¼‰
            // ç­–ç•¥ï¼šæ¯æ¬¡éš¨æ©Ÿé¸æ“‡ä¸€å€‹äººæ•¸æœ€å°‘çš„çµ„
            for (const student of shuffledNonLeaders) {
                // æ‰¾å‡ºç›®å‰äººæ•¸æœ€å°‘çš„çµ„
                const minMembers = Math.min(...state.groups.map(g => g.members.length));
                // æ‰¾å‡ºæ‰€æœ‰äººæ•¸æœ€å°‘çš„çµ„
                const smallestGroups = state.groups.filter(g => g.members.length === minMembers);
                // éš¨æ©Ÿé¸æ“‡å…¶ä¸­ä¸€å€‹
                const targetGroup = smallestGroups[Math.floor(Math.random() * smallestGroups.length)];
                targetGroup.members.push(student);
            }

            // æœ€å¾Œæ‰“äº‚çµ„åˆ¥åœ¨é™£åˆ—ä¸­çš„é †åº
            state.groups = shuffle(state.groups);

            // é‡æ–°ç·¨è™Ÿçµ„åˆ¥ IDï¼ˆä¿æŒ 1, 2, 3... çš„é †åºï¼‰
            state.groups.forEach((group, index) => {
                group.id = index + 1;
            });

            // æ¸²æŸ“çµæœ
            renderResults();
        }

        // æ¸²æŸ“åº§ä½è¡¨
        function renderSeatChart() {
            const container = document.getElementById('seatChart');
            container.innerHTML = '';

            for (const student of state.students) {
                const seat = document.createElement('div');
                seat.className = `seat w-12 h-12 flex items-center justify-center rounded-lg cursor-pointer font-bold text-white ${student.active ? 'active' : 'inactive'}`;

                if (student.isLeader) {
                    seat.classList.add('leader');
                }

                if (state.settings.leaderMode && student.active) {
                    seat.classList.add('ring-2', 'ring-amber-400');
                }

                seat.textContent = String(student.id).padStart(2, '0');
                seat.onclick = () => toggleStudent(student.id);

                container.appendChild(seat);
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const activeCount = state.students.filter(s => s.active).length;
            const leaderCount = state.students.filter(s => s.isLeader).length;

            const statsDiv = document.getElementById('statsInfo');
            statsDiv.innerHTML = `
                <span class="mr-4">åƒèˆ‡äººæ•¸: <strong class="text-green-600">${activeCount}</strong> äºº</span>
                <span>å·²é¸çµ„é•·: <strong class="text-amber-600">${leaderCount}</strong> äºº</span>
            `;
        }

        // å»ºç«‹å¯¦é©—æ¡Œå…ƒç´ 
        function createLabBench(group) {
            const bench = document.createElement('div');
            bench.className = 'lab-bench';
            bench.dataset.group = group ? group.id : '';

            if (!group) {
                bench.classList.add('empty');
            }

            // å·¦å´åº§ä½
            const leftSeats = document.createElement('div');
            leftSeats.className = 'bench-seats-left';

            // çµ„åˆ¥æ¨™ç±¤
            const label = document.createElement('div');
            label.className = 'bench-label';
            label.textContent = group ? group.id : '-';

            // å³å´åº§ä½
            const rightSeats = document.createElement('div');
            rightSeats.className = 'bench-seats-right';

            if (group && group.members.length > 0) {
                // æ’åºï¼šçµ„é•·å„ªå…ˆï¼Œå…¶é¤˜æŒ‰åº§è™Ÿ
                const sortedMembers = [...group.members].sort((a, b) => {
                    if (a.id === group.leaderId) return -1;
                    if (b.id === group.leaderId) return 1;
                    return a.id - b.id;
                });

                // äº¤å‰åˆ†é…åº§ä½ï¼šå³â†’å·¦â†’å³â†’å·¦...ï¼Œä½¿å·¦å³å¹³è¡¡
                // å¶æ•¸ç´¢å¼•ï¼ˆ0, 2, 4ï¼‰â†’ å³å´
                // å¥‡æ•¸ç´¢å¼•ï¼ˆ1, 3, 5ï¼‰â†’ å·¦å´
                const rightMembers = sortedMembers.filter((_, i) => i % 2 === 0);
                const leftMembers = sortedMembers.filter((_, i) => i % 2 === 1);

                const maxSeatsPerSide = 3;
                for (let i = 0; i < maxSeatsPerSide; i++) {
                    // å·¦å´åº§ä½
                    const leftSeat = document.createElement('div');
                    leftSeat.className = 'bench-seat';
                    if (i < leftMembers.length) {
                        const member = leftMembers[i];
                        if (member.id === group.leaderId) {
                            leftSeat.classList.add('is-leader');
                            leftSeat.innerHTML = `ãŠ—ï¸ ${String(member.id).padStart(2, '0')}`;
                        } else {
                            leftSeat.textContent = String(member.id).padStart(2, '0');
                        }
                    } else {
                        leftSeat.classList.add('empty-seat');
                        leftSeat.textContent = '--';
                    }
                    leftSeats.appendChild(leftSeat);

                    // å³å´åº§ä½
                    const rightSeat = document.createElement('div');
                    rightSeat.className = 'bench-seat';
                    if (i < rightMembers.length) {
                        const member = rightMembers[i];
                        if (member.id === group.leaderId) {
                            rightSeat.classList.add('is-leader');
                            rightSeat.innerHTML = `ãŠ—ï¸ ${String(member.id).padStart(2, '0')}`;
                        } else {
                            rightSeat.textContent = String(member.id).padStart(2, '0');
                        }
                    } else {
                        rightSeat.classList.add('empty-seat');
                        rightSeat.textContent = '--';
                    }
                    rightSeats.appendChild(rightSeat);
                }
            } else {
                // ç©ºæ¡Œï¼šé¡¯ç¤ºç©ºåº§ä½
                for (let i = 0; i < 3; i++) {
                    const leftSeat = document.createElement('div');
                    leftSeat.className = 'bench-seat empty-seat';
                    leftSeat.textContent = '--';
                    leftSeats.appendChild(leftSeat);

                    const rightSeat = document.createElement('div');
                    rightSeat.className = 'bench-seat empty-seat';
                    rightSeat.textContent = '--';
                    rightSeats.appendChild(rightSeat);
                }
            }

            bench.appendChild(leftSeats);
            bench.appendChild(label);
            bench.appendChild(rightSeats);

            return bench;
        }

        // æ¸²æŸ“åˆ†çµ„çµæœ
        function renderResults() {
            const section = document.getElementById('resultsSection');
            const container = document.getElementById('resultsContainer');

            section.classList.remove('hidden');
            container.innerHTML = '';

            // å»ºç«‹å¯¦é©—å®¤åº§ä½åœ–
            const labLayout = document.createElement('div');
            labLayout.className = 'lab-layout';

            // è¬›æ¡Œ
            const teacherDesk = document.createElement('div');
            teacherDesk.className = 'teacher-desk';
            teacherDesk.textContent = 'è¬›æ¡Œï¼ˆåŒ–å­¸å¯¦é©—å®¤ï¼‰';
            labLayout.appendChild(teacherDesk);

            // å»ºç«‹çµ„åˆ¥å°ç…§è¡¨
            const groupMap = {};
            for (const group of state.groups) {
                groupMap[group.id] = group;
            }

            // å‰æ’ï¼šç¬¬4çµ„ã€ç¬¬3çµ„ã€ç¬¬2çµ„ã€ç¬¬1çµ„ï¼ˆç”±å·¦è‡³å³ï¼‰
            const frontRow = document.createElement('div');
            frontRow.className = 'lab-row';
            [4, 3, 2, 1].forEach(groupId => {
                frontRow.appendChild(createLabBench(groupMap[groupId] || null));
            });
            labLayout.appendChild(frontRow);

            // å¾Œæ’ï¼šç¬¬8çµ„ã€ç¬¬7çµ„ã€ç¬¬6çµ„ã€ç¬¬5çµ„ï¼ˆç”±å·¦è‡³å³ï¼‰
            const backRow = document.createElement('div');
            backRow.className = 'lab-row';
            [8, 7, 6, 5].forEach(groupId => {
                backRow.appendChild(createLabBench(groupMap[groupId] || null));
            });
            labLayout.appendChild(backRow);

            container.appendChild(labLayout);

            // è™•ç†è¶…é 8 çµ„çš„æƒ…æ³
            if (state.groups.length > 8) {
                const extraGroups = state.groups.filter(g => g.id > 8);

                const notice = document.createElement('div');
                notice.className = 'extra-groups-notice';
                notice.textContent = `âš ï¸ çµ„æ•¸è¶…é 8 çµ„ï¼Œä»¥ä¸‹ç¬¬ 9 çµ„ä»¥å¾Œçš„åˆ†çµ„éœ€è¦å¦è¡Œå®‰æ’åº§ä½`;
                container.appendChild(notice);

                const extraContainer = document.createElement('div');
                extraContainer.className = 'extra-groups-container';

                const extraTitle = document.createElement('h3');
                extraTitle.textContent = 'é¡å¤–åˆ†çµ„';
                extraContainer.appendChild(extraTitle);

                const extraGrid = document.createElement('div');
                extraGrid.className = 'results-container';

                for (const group of extraGroups) {
                    const card = document.createElement('div');
                    card.className = 'group-card';

                    const label = document.createElement('div');
                    label.className = 'group-label';
                    label.textContent = `ç¬¬ ${group.id} çµ„`;

                    const membersDiv = document.createElement('div');
                    membersDiv.className = 'group-members';

                    const sortedMembers = [...group.members].sort((a, b) => {
                        if (a.id === group.leaderId) return -1;
                        if (b.id === group.leaderId) return 1;
                        return a.id - b.id;
                    });

                    for (const member of sortedMembers) {
                        const memberDiv = document.createElement('div');
                        memberDiv.className = `member ${member.id === group.leaderId ? 'is-leader' : ''}`;

                        if (member.id === group.leaderId) {
                            memberDiv.innerHTML = `ãŠ—ï¸ ${String(member.id).padStart(2, '0')}`;
                        } else {
                            memberDiv.textContent = String(member.id).padStart(2, '0');
                        }

                        membersDiv.appendChild(memberDiv);
                    }

                    card.appendChild(label);
                    card.appendChild(membersDiv);
                    extraGrid.appendChild(card);
                }

                extraContainer.appendChild(extraGrid);
                container.appendChild(extraContainer);
            }

            // æ»¾å‹•åˆ°çµæœå€åŸŸ
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ä¸‹è¼‰åˆ†çµ„çµæœåœ–ç‰‡
        function downloadResultsImage() {
            const container = document.getElementById('resultsContainer');
            html2canvas(container, {
                backgroundColor: '#ffffff',
                scale: 2  // é«˜è§£æåº¦
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'åˆ†çµ„çµæœ.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // é‡ç½®
        function resetAll() {
            // é‡ç½®å­¸ç”Ÿç‹€æ…‹
            initStudents();

            // é‡ç½®è¨­å®š
            state.settings.leaderMode = false;
            state.groups = [];

            // é‡ç½® UI
            document.getElementById('groupCount').value = 8;
            document.getElementById('groupSize').value = '';

            const btn = document.getElementById('leaderModeBtn');
            btn.classList.remove('leader-mode-active', 'ring-2', 'ring-amber-300');
            btn.textContent = 'é¸çµ„é•·æ¨¡å¼';

            document.getElementById('resultsSection').classList.add('hidden');

            renderSeatChart();
            updateStats();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initStudents();
            renderSeatChart();
            updateStats();
        });
    </script>
</body>
</html>
